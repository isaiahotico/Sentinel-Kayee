<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Auth Callback</title>
    <link rel="stylesheet" href="style.css"> <!-- Optional: Link to your main stylesheet for consistency -->
    <!-- Load Telegram Widget script to make TelegramLoginWidgetCallback globally available -->
    <script async src="https://telegram.org/js/telegram-widget.js?22"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e0e0e0; /* Light background for clarity */
            color: #333;
            text-align: center;
        }
        .auth-message {
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
    <div class="auth-message">
        <p>Authenticating with Telegram...</p>
        <p>If you are not redirected automatically, please click the link below.</p>
        <p id="redirect-link-container"></p>
    </div>

    <script>
        // Function to handle the Telegram login callback
        // This function MUST be globally accessible for the Telegram widget to call it.
        window.TelegramLoginWidgetCallback = async (userTelegramData) => {
            console.log("Auth callback received Telegram data:", userTelegramData);

            // Prepare the data to be passed to app.js or saved directly
            const authData = {
                id: userTelegramData.id,
                first_name: userTelegramData.first_name,
                last_name: userTelegramData.last_name,
                username: userTelegramData.username,
                photo_url: userTelegramData.photo_url,
                auth_date: userTelegramData.auth_date,
                hash: userTelegramData.hash // Security parameter
            };

            // --- Option 1: Redirect back to your main app page with data ---
            // This is a common approach. You might pass the data as URL parameters
            // or use localStorage/sessionStorage if redirecting back to the same origin.
            // For simplicity and security (avoiding sensitive data in URL), we'll use localStorage.

            try {                localStorage.setItem('telegram_user_data', JSON.stringify(authData));
                console.log("Telegram data stored in localStorage.");

                // Now, redirect back to your main application page (e.g., index.html)
                // Make sure the URL is correct for your setup.
                const redirectUrl = window.location.origin + "/index.html" + window.location.search; // Keep existing query params if any
                window.location.href = redirectUrl;

            } catch (error) {
                console.error("Error storing Telegram data or redirecting:", error);
                document.querySelector('.auth-message p').textContent = "Authentication failed. Please try again.";
                document.getElementById('redirect-link-container').innerHTML = `<a href="index.html">Go back to App</a>`;
            }

            // --- Option 2: Directly call a function in your main app.js (more complex for cross-origin) ---
            // If your 'auth.html' and 'app.js' are on the same origin, you could potentially
            // access `window.parent.app.js.TelegramLoginWidgetCallback(authData)` but this is tricky.
            // The redirect method is more robust.

            // --- Option 3: Send data to a backend API first (Most Secure for Token Validation) ---
            /*
            fetch('/api/telegram-login-callback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(authData)
            })
            .then(response => response.json())
            .then(data => {
                // If your backend returned a Firebase custom token or JWT
                if (data.customToken) {
                    // Use Firebase Auth to sign in
                    // ...
                    window.location.href = "index.html"; // Redirect to main app
                } else {
                    // Handle error or fallback
                    document.querySelector('.auth-message p').textContent = "Authentication failed. Please try again.";
                    document.getElementById('redirect-link-container').innerHTML = `<a href="index.html">Go back to App</a>`;
                }
            })
            .catch(error => {
                console.error("Error sending data to backend:", error);
                document.querySelector('.auth-message p').textContent = "Authentication failed. Please try again.";
                document.getElementById('redirect-link-container').innerHTML = `<a href="index.html">Go back to App</a>`;
            });
            */
        };

        // Display a manual link if redirection fails or takes too long
        setTimeout(() => {
            const redirectLink = document.getElementById('redirect-link-container');
            if (redirectLink && !redirectLink.innerHTML) { // Only add if not already populated
                redirectLink.innerHTML = `<a href="index.html">Go back to App</a>`;
            }
        }, 5000); // Show link after 5 seconds if not redirected
    </script>
</body>
</html>
